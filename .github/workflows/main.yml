name: nixcfg Continuous Integration

on:
  push:
    branches:
      - main

jobs:
  lint_nixcfg:
    name: nixcfg linting
    runs-on: self-hosted
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Formatting with nixfmt
        run: nixfmt . -c

      - name: Antipattern linting for Nix code with statix
        run: statix check . -i docker-compose.nix

      - name: Scan nix file for dead code with deadnix
        run: deadnix . -f

      - name: Nix Flake check no build
        run: nix flake check --no-build github:NixOS/patchelf --all-systems --keep-going

  build_Beaver:
    name: building Beaver
    runs-on: self-hosted
    needs: lint_nixcfg
    outputs:
      built: ${{ steps.set_build_status.outputs.built }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Check changes in Beaver folder
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            beaver:
              - 'Beaver/**'

      - name: Check flake is correct
        run: nix flake check --all-systems --keep-going --impure
        if: steps.changes.outputs.beaver == 'true'

      - name: Build Beaver
        run: nix build .#nixosConfigurations.BeaverNixos.config.system.build.toplevel --impure
        if: steps.changes.outputs.beaver == 'true'

      - name: Save Beaver build
        run: |
          mkdir -p /run/github-runner/deploy/beaver${{ github.sha }}
          mv result /run/github-runner/deploy/beaver${{ github.sha }}
        if: steps.changes.outputs.beaver == 'true'

      - name: Set build status
        run: echo "built=${{ steps.changes.outputs.beaver == 'true' }}" >> $GITHUB_OUTPUT
        if: steps.changes.outputs.beaver == 'true'

  deploy_Beaver:
    name: deploy Beaver
    runs-on: self-hosted
    needs: build_Beaver
    if: needs.build_Beaver.outputs.built == 'true'

    steps:
      - name: Deploy Beaver
        run: /run/github-runner/deploy/beaver${{ github.sha }}/bin/switch-to-configuration switch 

